╔══════════════════════════════════════════════════════════════════════════════════╗
║                     CAREFORALL FUNDRAISING PLATFORM                              ║
║                     Next-Generation Microservices Architecture                    ║
╚══════════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────────┐
│                              PUBLIC INTERNET                                      │
│                                                                                   │
│                          HTTPS (TLS 1.2/1.3)                                     │
└─────────────────────────────────┬────────────────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│                           API GATEWAY (Nginx)                                     │
│                              Port 8000                                            │
│  ┌────────────────────────────────────────────────────────────────────────────┐  │
│  │  Features:                                                                 │  │
│  │  • Round-robin load balancing                                             │  │
│  │  • Rate limiting (100 req/min per IP)                                     │  │
│  │  • Health checks (every 10s)                                              │  │
│  │  • Circuit breaker (opens after 5 failures)                               │  │
│  │  • Request timeout (30s)                                                  │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
└─────────────┬────────────┬────────────┬────────────┬─────────────────────────────┘
              │            │            │            │
       ┌──────┴───┐  ┌─────┴────┐ ┌────┴─────┐ ┌───┴──────┐
       │          │  │          │ │          │ │          │
       ▼          ▼  ▼          ▼ ▼          ▼ ▼          ▼

╔═══════════════════════════════════════════════════════════════════════════════════╗
║                          MICROSERVICES LAYER                                      ║
╚═══════════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────────┐
│  DONATION SERVICE    │  │  PAYMENT SERVICE     │  │  TOTALS SERVICE      │
│     Port 8001        │  │     Port 8002        │  │     Port 8003        │
│   (3 replicas)       │  │   (3 replicas)       │  │   (2 replicas)       │
├──────────────────────┤  ├──────────────────────┤  ├──────────────────────┤
│                      │  │                      │  │                      │
│ ┌──────────────────┐ │  │ ┌──────────────────┐ │  │ ┌──────────────────┐ │
│ │ FastAPI          │ │  │ │ FastAPI          │ │  │ │ FastAPI          │ │
│ │ + OpenTelemetry  │ │  │ │ + OpenTelemetry  │ │  │ │ + OpenTelemetry  │ │
│ │ + Prometheus     │ │  │ │ + Prometheus     │ │  │ │ + Prometheus     │ │
│ └──────────────────┘ │  │ └──────────────────┘ │  │ └──────────────────┘ │
│                      │  │                      │  │                      │
│ Core Features:       │  │ Core Features:       │  │ Core Features:       │
│ ✓ Transactional      │  │ ✓ Idempotency        │  │ ✓ Redis Cache (L1)   │
│   Outbox Pattern     │  │   - Redis cache      │  │   30s TTL            │
│ ✓ Donation History   │  │   - DB persistence   │  │ ✓ Materialized       │
│ ✓ Audit Logs         │  │ ✓ State Machine      │  │   View (L2)          │
│ ✓ Event Publishing   │  │   - Versioning       │  │ ✓ Real-time Query    │
│                      │  │   - Event ordering   │  │   (L3)               │
│                      │  │ ✓ Webhook Handling   │  │ ✓ Event-driven       │
│                      │  │                      │  │   Cache Invalidation │
└──────────┬───────────┘  └──────────┬───────────┘  └──────────────────────┘
           │                         │
           │                         │
           │ publishes events        │ publishes events
           │                         │
           └─────────┬───────────────┘
                     │
                     ▼
         ┌───────────────────────┐
         │  OUTBOX PROCESSOR     │
         │  (Background Worker)  │
         ├───────────────────────┤
         │ • Polls outbox table  │
         │ • Publishes to        │
         │   RabbitMQ            │
         │ • At-least-once       │
         │   delivery            │
         │ • Automatic retry     │
         └───────────┬───────────┘
                     │
                     ▼
         ┌───────────────────────────────────┐
         │        MESSAGE BROKER             │
         │         RabbitMQ                  │
         │       Port 5672, 15672            │
         ├───────────────────────────────────┤
         │                                   │
         │  Exchanges:                       │
         │  • donations.events (topic)       │
         │  • payments.events (topic)        │
         │                                   │
         │  Queues:                          │
         │  • totals.queue                   │
         │  • notifications.queue            │
         │  • audit.queue                    │
         │                                   │
         │  Features:                        │
         │  • Durable messages               │
         │  • Dead letter queues             │
         │  • Message persistence            │
         └───────────┬───────────┬───────────┘
                     │           │
              ┌──────┘           └──────┐
              │                         │
              ▼                         ▼
┌────────────────────────┐  ┌──────────────────────┐
│ NOTIFICATION SERVICE   │  │  Other Consumers     │
│     Port 8004          │  │  (Future Services)   │
│   (2 replicas)         │  └──────────────────────┘
├────────────────────────┤
│                        │
│ Features:              │
│ ✓ Email (SendGrid)     │
│ ✓ SMS (Twilio)         │
│ ✓ Webhooks             │
│ ✓ Retry Logic          │
│ ✓ Notification History │
└────────────────────────┘

╔═══════════════════════════════════════════════════════════════════════════════════╗
║                              DATA LAYER                                           ║
╚═══════════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────────┐
│                            POSTGRESQL CLUSTER                                     │
│                              Port 5432                                            │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                   │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │  donations_db    │  │  payments_db     │  │  notifications_db│              │
│  ├──────────────────┤  ├──────────────────┤  ├──────────────────┤              │
│  │ • donations      │  │ • payment_trans  │  │ • notifications  │              │
│  │ • outbox_events  │  │ • idempotency_   │  │ • delivery_logs  │              │
│  │ • audit_logs     │  │   keys           │  │                  │              │
│  │                  │  │ • state_history  │  │                  │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
│                                                                                   │
│  Features:                                                                        │
│  • Connection pooling (20 per service)                                           │
│  • Indexes on frequently queried columns                                         │
│  • Materialized views for aggregations                                           │
│  • Automatic backups (daily)                                                     │
│  • Read replicas (production)                                                    │
└──────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────┐
│                              REDIS CLUSTER                                        │
│                               Port 6379                                           │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                   │
│  Database 0: Donation Service Cache                                              │
│  Database 1: Payment Service (Idempotency Keys)                                  │
│  Database 2: Totals Service Cache                                                │
│  Database 3: Notification Service Cache                                          │
│                                                                                   │
│  Features:                                                                        │
│  • TTL-based expiration (30s for totals)                                         │
│  • LRU eviction policy                                                           │
│  • Persistence (AOF + RDB)                                                       │
│  • Sentinel for HA (production)                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘

╔═══════════════════════════════════════════════════════════════════════════════════╗
║                         OBSERVABILITY STACK                                       ║
╚═══════════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────────┐
│   PROMETHEUS         │  │      GRAFANA         │  │       JAEGER         │
│   Port 9090          │  │     Port 3000        │  │     Port 16686       │
├──────────────────────┤  ├──────────────────────┤  ├──────────────────────┤
│                      │  │                      │  │                      │
│ Metrics Collection:  │  │ Dashboards:          │  │ Distributed Tracing: │
│ • /metrics endpoints │◄─┤ • System Overview    │  │ • Request traces     │
│ • Scrape every 15s   │  │ • Request rate       │  │ • Span details       │
│ • Time-series DB     │  │ • Latency (P95/P99)  │  │ • Service map        │
│ • Alert rules        │  │ • Cache hit ratio    │  │ • Error tracking     │
│                      │  │ • Business metrics   │  │ • Performance        │
│                      │  │ • Custom queries     │  │   bottlenecks        │
└──────────────────────┘  └──────────────────────┘  └──────────────────────┘
         │                          │                          ▲
         │                          │                          │
         └──────────────────────────┴──────────────────────────┘
                                    │
                    All services export metrics & traces

╔═══════════════════════════════════════════════════════════════════════════════════╗
║                          DATA FLOW EXAMPLE                                        ║
║                   Complete Donation Lifecycle                                     ║
╚═══════════════════════════════════════════════════════════════════════════════════╝

1. Donor creates donation
   │
   ▼
2. API Gateway → Donation Service
   │  • Validates request
   │  • Rate limiting check
   │
   ▼
3. Donation Service (Transaction):
   │  • INSERT INTO donations (...)
   │  • INSERT INTO outbox_events (...)
   │  • COMMIT (both or neither)
   │
   ▼
4. Outbox Processor:
   │  • Polls outbox_events
   │  • Publishes to RabbitMQ
   │  • Marks as processed
   │
   ▼
5. RabbitMQ routes event to:
   │
   ├──► Notification Service
   │    • Sends confirmation email
   │    • Logs notification
   │
   └──► Payment Service
        • Creates payment intent
        • Returns client_secret
        │
        ▼
6. Frontend completes payment with Stripe
   │
   ▼
7. Stripe sends webhook → Payment Service:
   │  • Checks idempotency key (Redis)
   │  • If cached → return cached response
   │  • If new → process webhook:
   │    - Validate state transition
   │    - Check event ordering
   │    - Update payment status
   │    - Save idempotency record
   │    - Publish payment.completed event
   │
   ▼
8. RabbitMQ routes payment.completed to:
   │
   ├──► Totals Service
   │    • Invalidates cache
   │    • Refreshes totals
   │
   ├──► Donation Service
   │    • Updates donation status to COMPLETED
   │
   └──► Notification Service
        • Sends payment confirmation

9. Throughout entire flow:
   │  • Traces logged to Jaeger
   │  • Metrics collected by Prometheus
   │  • Dashboards updated in Grafana

╔═══════════════════════════════════════════════════════════════════════════════════╗
║                     FAULT TOLERANCE MECHANISMS                                    ║
╚═══════════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────────┐
│ IDEMPOTENCY (Payment Service)                                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                   │
│  Webhook arrives with idempotency key                                            │
│          │                                                                        │
│          ▼                                                                        │
│  ┌────────────────┐  Hit    ┌──────────────────────┐                           │
│  │ Redis Cache    │────────►│ Return cached response│                           │
│  │ (Fast path)    │         │ (~5ms)                │                           │
│  └────────┬───────┘         └──────────────────────┘                           │
│           │ Miss                                                                 │
│           ▼                                                                      │
│  ┌────────────────┐  Hit    ┌──────────────────────┐                           │
│  │ Database       │────────►│ Return cached response│                           │
│  │ (Persistent)   │         │ (~50ms)               │                           │
│  └────────┬───────┘         └──────────────────────┘                           │
│           │ Miss                                                                 │
│           ▼                                                                      │
│  ┌────────────────────────────────────┐                                         │
│  │ Process webhook (first time)       │                                         │
│  │ • Validate state transition        │                                         │
│  │ • Update payment status            │                                         │
│  │ • Save to Redis + DB               │                                         │
│  │ • Return response                  │                                         │
│  └────────────────────────────────────┘                                         │
│                                                                                   │
│  Result: Duplicate webhooks never reprocess payment                              │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│ TRANSACTIONAL OUTBOX (Donation Service)                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                   │
│  BEGIN TRANSACTION                                                                │
│      │                                                                            │
│      ├─► INSERT donation                                                         │
│      │                                                                            │
│      └─► INSERT outbox_event                                                     │
│                                                                                   │
│  COMMIT (atomic - both or neither)                                               │
│                                                                                   │
│  Crash here? ─► Both writes rolled back ✓                                        │
│  Success?    ─► Both writes committed ✓                                          │
│                                                                                   │
│  Separate process:                                                                │
│      • Polls outbox_events WHERE processed_at IS NULL                            │
│      • Publishes to RabbitMQ                                                     │
│      • Marks processed_at = NOW()                                                │
│      • Retries on failure                                                        │
│                                                                                   │
│  Result: No lost donations, guaranteed event delivery                            │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│ STATE MACHINE (Payment Service)                                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                   │
│  Valid Transitions:                                                               │
│                                                                                   │
│      INITIATED ──────┬──────► AUTHORIZED ──────┬──────► CAPTURED                │
│                      │                          │                                │
│                      │                          ├──────► REFUNDED                │
│                      │                          │                                │
│                      └──────► FAILED            └──────► FAILED                  │
│                                                                                   │
│  Webhook arrives:                                                                 │
│      1. Lock payment row                                                          │
│      2. Check event timestamp vs current state timestamp                         │
│         • If older → ignore (out of order)                                       │
│      3. Validate transition is in VALID_TRANSITIONS                              │
│         • If invalid → reject                                                    │
│      4. Update status + increment version                                        │
│      5. Log to payment_state_history                                             │
│      6. Commit                                                                   │
│                                                                                   │
│  Result: State corruption impossible, full audit trail                           │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│ MULTI-LEVEL CACHING (Totals Service)                                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                   │
│  Request for campaign totals                                                      │
│          │                                                                        │
│          ▼                                                                        │
│  ┌──────────────────┐  Hit (90%)  ┌──────────────────┐                         │
│  │ L1: Redis Cache  │────────────►│ Return (10ms)    │                         │
│  │ (30s TTL)        │             │                  │                         │
│  └────────┬─────────┘             └──────────────────┘                         │
│           │ Miss (10%)                                                           │
│           ▼                                                                      │
│  ┌──────────────────────┐  Hit (9%)  ┌──────────────────┐                      │
│  │ L2: Materialized View│───────────►│ Return (50ms)    │                      │
│  │ (refreshed every 5m) │            │ + populate Redis │                      │
│  └────────┬─────────────┘            └──────────────────┘                      │
│           │ Miss (1%)                                                            │
│           ▼                                                                      │
│  ┌──────────────────────┐                                                        │
│  │ L3: Real-time Query  │           ┌──────────────────┐                        │
│  │ (Base table)         │──────────►│ Return (200ms)   │                       │
│  │                      │           │ + populate caches│                        │
│  └──────────────────────┘           └──────────────────┘                        │
│                                                                                   │
│  Cache invalidation:                                                              │
│      • payment.completed event → invalidate campaign cache                       │
│                                                                                   │
│  Result: 90% of requests served in 10ms, database load reduced by 90%           │
└─────────────────────────────────────────────────────────────────────────────────┘

╔═══════════════════════════════════════════════════════════════════════════════════╗
║                        PERFORMANCE CHARACTERISTICS                                ║
╚═══════════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────────┐
│ Latency (P95):                                                                    │
│   • Donation creation: ~50ms                                                      │
│   • Payment webhook (cached): ~5ms                                                │
│   • Payment webhook (uncached): ~100ms                                            │
│   • Totals (cached): ~10ms                                                        │
│   • Totals (real-time): ~200ms                                                    │
│                                                                                   │
│ Throughput:                                                                       │
│   • Per service replica: ~500 req/s                                               │
│   • With 3 replicas: ~1500 req/s per service                                      │
│   • Total system: ~3000 req/s                                                     │
│                                                                                   │
│ Cache Hit Ratio:                                                                  │
│   • Redis (L1): ~90%                                                              │
│   • Materialized View (L2): ~9%                                                   │
│   • Real-time (L3): ~1%                                                           │
│                                                                                   │
│ Database Connections:                                                             │
│   • Pool size per service: 20                                                     │
│   • Max overflow: 40                                                              │
│   • Total with 3 replicas: 60 connections                                         │
└─────────────────────────────────────────────────────────────────────────────────┘

Legend:
  ─►  Data flow
  ◄─  Query/Fetch
  ✓   Success/Guaranteed
  ✗   Failure/Rejected

